# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: '3'

vars:
  IMAGE_BUILDER: ghcr.io/osbuild/image-builder-cli:latest@sha256:f50eeec5689673314a1c73772d7721bd4090e9e25aee40075488ec31857c59f6
  DISTRO: fedora-43
  ARCH: aarch64
  OSTREE_REF: fedora/stable/{{.ARCH}}/iot
  OUTPUT_DIR: '{{joinPath .ROOT_DIR "output"}}'
  BLUEPRINTS_DIR: '{{joinPath .ROOT_DIR "blueprints"}}'
  REPO_DIR: '{{joinPath .OUTPUT_DIR "repos"}}'
  PKG_REPO_DIR: '{{joinPath .REPO_DIR "ExtraPackages"}}'

tasks:
  build:package:
    desc: Generate the PKI package and an RPM repository
    cmds:
      - goreleaser release --clean --snapshot
      - mkdir -p "{{.PKG_REPO_DIR}}"
      - cp dist/*.rpm "{{.PKG_REPO_DIR}}"
      - >-
        docker run -it --rm \
          -v "{{.PKG_REPO_DIR}}":/repo \
          quay.io/distributedci/dci-packaging-createrepo createrepo /repo
    sources:
      - .goreleaser.yaml
      - cmd/**/*.go
    generates:
      - '{{.PKG_REPO_DIR}}/repodata/repomd.xml'

  build:iot-commit:
    desc: Generate the iot-commit ostree repository
    deps:
      - build:package
    cmds:
      - >-
        docker run -it --rm --privileged \
          -v "{{.OUTPUT_DIR}}":/output \
          -v "{{.BLUEPRINTS_DIR}}":/blueprints \
          -v "{{.PKG_REPO_DIR}}:/repo" \
          {{.IMAGE_BUILDER}} build iot-commit \
            --arch {{.ARCH}} \
            --distro {{.DISTRO}} \
            --extra-repo file:///repo \
            --ostree-ref {{.OSTREE_REF}} \
            --blueprint /blueprints/base.toml \
            --output-dir /output
    sources:
      - blueprints/base.toml
      - '{{.PKG_REPO_DIR}}/repodata/repomd.xml'
    generates:
      - 'output/{{.DISTRO}}-iot-commit-{{.ARCH}}.tar'

  build:image:
    desc: Build the device image
    deps:
      - build:iot-commit
    vars:
      IOT_REPO_DIR: '{{joinPath .REPO_DIR "iot"}}'
      NETWORK: builder
    cmds:
      - docker network create {{.NETWORK}}
      - defer: docker network rm {{.NETWORK}}
      - mkdir -p "{{.IOT_REPO_DIR}}"
      - tar xf output/{{.DISTRO}}-iot-commit-{{.ARCH}}.tar -C "{{.IOT_REPO_DIR}}" --strip-components=2 repo
      - defer: rm -rf "{{.IOT_REPO_DIR}}"
      - >-
        docker run -d --rm \
          -v "{{.IOT_REPO_DIR}}":/repo \
          --workdir /repo \
          --name repo \
          --network {{.NETWORK}} \
          cgr.dev/chainguard/python -m http.server 8000
      - defer: docker container stop repo
      - >-
        docker run -it --rm --privileged \
          -v "{{.OUTPUT_DIR}}":/output \
          -v "{{.BLUEPRINTS_DIR}}":/blueprints \
          --network {{.NETWORK}} \
          {{.IMAGE_BUILDER}} build iot-raw-xz \
            --arch {{.ARCH}} \
            --distro {{.DISTRO}} \
            --ostree-ref {{.OSTREE_REF}} \
            --ostree-url http://repo:8000 \
            --blueprint /blueprints/image.toml \
            --output-dir /output
    sources:
      - blueprints/image.toml
      - 'output/{{.DISTRO}}-iot-commit-{{.ARCH}}.tar'
    generates:
      - 'output/{{.DISTRO}}-iot-raw-xz-{{.ARCH}}.raw.xz'

  write:*:
    desc: Write the device image to a disk attached to this system
    deps:
      - build:image
    vars:
      IDENTIFIER: '{{index .MATCH 0}}'
      DISK_SIZE:
        sh: diskutil info {{.IDENTIFIER}} | sed -n -e 's/^[[:space:]]*Disk Size:[[:space:]]*//p' | cut -d ' ' -f1,2
    prompt: WARNING! This command will overwrite the contents of {{.IDENTIFIER}} ({{.DISK_SIZE}}), would you like to continue?
    cmds:
      - diskutil eraseDisk "MS-DOS" DISK MBR {{.IDENTIFIER}}
      - diskutil unmountDisk force {{.IDENTIFIER}}
      - 'xzcat "output/{{.DISTRO}}-iot-raw-xz-{{.ARCH}}.raw.xz" | sudo dd status=progress bs=4m of=/dev/r{{.IDENTIFIER}}'
      - diskutil unmountDisk {{.IDENTIFIER}}

  clean:
    desc: Remove built artifacts
    cmds:
      -
      - 'rm -rf {{.OUTPUT_DIR}}'
